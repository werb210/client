# ============================
# CLIENT APPLICATION — CLEANUP / ROLLBACK
# Purpose: remove MyTasks page, client docreq routes/mount, and preview middleware changes I added.
# After this, do NOT modify the client app further.
# ============================
set -euo pipefail

echo ">>> Starting client cleanup…"

# 1) Remove MyTasks UI (if present)
rm -f client/src/client/MyTasks.tsx || true

# 2) Remove MyTasks import/route from client/src/App.tsx
if [ -f client/src/App.tsx ]; then
  # drop import line
  sed -i.bak '/import .*MyTasks.*from ".\/client\/MyTasks";/d' client/src/App.tsx || true
  # drop route line
  sed -i.bak '/<Route .*path=.*"\/client\/tasks".*MyTasks .*\/>/d' client/src/App.tsx || true
fi

# 3) Remove client doc-request API routes (if created)
rm -rf server/routes/client/docreq || true
# Remove mount from server/index.ts
if [ -f server/index.ts ]; then
  # drop import
  sed -i.bak '/import .*clientDocreqRouter.*from ".\/routes\/client\/docreq";/d' server/index.ts || true
  # drop mount
  sed -i.bak 's/app\.use(.*"\/api\/client\/docreq".*);//g' server/index.ts || true
fi

# 4) Remove preview middleware + health endpoint that I added to the client app
rm -f server/middleware/replitPreview.ts 2>/dev/null || true
# Strip preview-related imports
sed -i.bak '/from ".\/middleware\/replitPreview"/d' server/index.ts 2>/dev/null || true
sed -i.bak '/import cors from "cors";/d' server/index.ts 2>/dev/null || true
# Strip trust proxy, CORS, helmet calls
sed -i.bak '/app\.set("trust proxy", 1);/d' server/index.ts 2>/dev/null || true
sed -i.bak '/app\.use(.*replitHelmet.*);/d' server/index.ts 2>/dev/null || true
sed -i.bak '/app\.use(.*stripXfo.*);/d' server/index.ts 2>/dev/null || true
sed -i.bak '/app\.use(.*cors(.*));/d' server/index.ts 2>/dev/null || true
# Remove dev health route (/_health)
awk 'BEGIN{skip=0} /DEV HEALTH ENDPOINT/ {skip=1} skip && /};/ {skip=0; next} skip==0 {print}' server/index.ts > server/index.ts.tmp 2>/dev/null || true
[ -f server/index.ts.tmp ] && mv server/index.ts.tmp server/index.ts || true
# Also remove any direct /_health line if no comment markers existed
sed -i.bak '/app\.get(.*"\/_health".*/,/});/d' server/index.ts 2>/dev/null || true

# 5) Rebuild & restart the client app (ignore build warnings)
npm run build || true
npm run start || true

echo ">>> Client cleanup complete. If Replit Preview still shows a gray box, click 'Open in new tab' once, then switch back."
