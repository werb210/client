# ┏ CLIENT (PROD): Fix token FP, consolidate .env, run alignment (TOKEN_ONLY → STRICT) ━━━┓
# Current gap: token FP = fe1af4f8b32f (wrong). Multiple .env files exist.
# What this does:
#  1) Verifies/sets the exact Staff CLIENT_SHARED_BEARER so FP == 0944508707a9
#  2) (Recommended) consolidate to ONE prod .env (no duplicates)
#  3) Runs alignment: TOKEN_ONLY now; STRICT auto-enables after Staff deploy verification
# Idempotent. Produces no duplicate helpers.
# ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
set -euo pipefail

VITE_STAFF_API_URL="${VITE_STAFF_API_URL:-https://staff.boreal.financial/api}"
BASE="${VITE_STAFF_API_URL%/}"
mkdir -p reports

echo "== CLIENT PROD ENV =="
echo "VITE_STAFF_API_URL=$BASE"

echo "== CURRENT TOKEN FINGERPRINT =="
node -e 'const c=require("crypto");const t=process.env.VITE_CLIENT_APP_SHARED_TOKEN||"";console.log(JSON.stringify({client_token_fp:c.createHash("sha256").update(t).digest("hex").slice(0,12)},null,2))'

echo "== CONSOLIDATE ENV (recommended) =="
echo "Search for duplicate definitions (keep ONE, e.g., .env.production):"
grep -R --line-number -E '^\s*VITE_CLIENT_APP_SHARED_TOKEN=' . 2>/dev/null || true
echo "If more than one line prints, remove extras and keep a single source of truth."

# Paste the EXACT Staff token (the secret string, not the fingerprint)
# export VITE_CLIENT_APP_SHARED_TOKEN='<<PASTE EXACT STAFF CLIENT_SHARED_BEARER HERE>>'

EXPECTED_TOKEN_FP="0944508707a9"
MY_FP="$(node -e 'const c=require("crypto");const t=process.env.VITE_CLIENT_APP_SHARED_TOKEN||"";process.stdout.write(c.createHash("sha256").update(t).digest("hex").slice(0,12))')"

if [ "$MY_FP" != "$EXPECTED_TOKEN_FP" ]; then
  echo "❌ TOKEN mismatch (got $MY_FP, need $EXPECTED_TOKEN_FP)."
  echo "→ Set VITE_CLIENT_APP_SHARED_BEARER to the Staff production token so FP=$EXPECTED_TOKEN_FP, then re-run."
  exit 10
fi
echo "✅ Token FP OK."

# Until Staff PROD is on the new build, EXPECTED_* will be minimal (TOKEN_ONLY mode).
export EXPECTED_DB_HOST="${EXPECTED_DB_HOST:-}"        # becomes Neon host after Staff block passes
export EXPECTED_PRODUCTS="${EXPECTED_PRODUCTS:-0}"     # becomes 44 after Staff block passes
export EXPECTED_LENDERS="${EXPECTED_LENDERS:-30}"      # target value
export EXPECTED_MIN_REQUIRED_DOCS="${EXPECTED_MIN_REQUIRED_DOCS:-6}"
export EXPECTED_TOKEN_FP="$EXPECTED_TOKEN_FP"

echo "== ALIGNMENT CHECK =="
PRODS_STATUS="$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer $VITE_CLIENT_APP_SHARED_TOKEN" "$BASE/v1/products")"
LENDS_STATUS="$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer $VITE_CLIENT_APP_SHARED_TOKEN" "$BASE/lenders")"
REQDOCS_STATUS="$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer $VITE_CLIENT_APP_SHARED_TOKEN" "$BASE/required-docs")"

echo "products=$PRODS_STATUS  lenders=$LENDS_STATUS  required-docs=$REQDOCS_STATUS"
echo ""
echo "MODE: TOKEN_ONLY now — will auto-switch to STRICT once Staff publishes headers + 44/30/≥6."
echo "✅ CLIENT DONE."
