âœ… Great â€” here's the **complete Replit AI instruction set** to fix **Step 5 Document Upload Duplication** in the **Client Application**.

---

## ğŸ“ REPLIT CLIENT INSTRUCTION â€” Step 5 Document Upload Logic Fix

> ğŸ”’ **Strict Compliance Mode ON**
> ğŸ›‘ Do nothing else.
> ğŸ§  Wait for all instructions.
> ğŸ“ Only apply exactly whatâ€™s written below.

---

### âœ… OBJECTIVE

Fix all **Step 5 document upload logic issues**, including:

1. ğŸ§© **Duplicate upload areas** (e.g. Financial Statements shown twice)
2. ğŸ›‘ **Validation failing due to ghost required sections**
3. ğŸ”„ **Inconsistent mapping of labels â†’ document types**

---

### ğŸ§© PATCH 1 â€” Deduplicate Upload Cards by `documentType`

**File:** `client/src/components/DynamicDocumentRequirements.tsx`

#### âœ… Step 1.1 â€” Replace label deduplication with document type deduplication:

```tsx
// â›”ï¸ OLD:
const renderedLabels = new Set<string>();

// âœ… NEW:
const renderedDocTypes = new Set<string>();
```

#### âœ… Step 1.2 â€” Inside the document rendering loop:

```tsx
const docType = normalizeDocumentName(doc.label);
if (renderedDocTypes.has(docType)) return null;
renderedDocTypes.add(docType);
```

---

### ğŸ”„ PATCH 2 â€” Standardize Document Type Mapping Across Upload + Display + Validation

**File:** `shared/documentTypes.ts`

#### âœ… Step 2.1 â€” Add a shared normalization function:

```ts
export function normalizeDocumentName(label: string): string {
  return label.trim().toLowerCase().replace(/\s+/g, '_');
}
```

#### âœ… Step 2.2 â€” Update all uses of:

* `getApiCategory()`
* `getApiDocumentType()`
* `.toLowerCase().replace()` style mapping

to now use:

```ts
normalizeDocumentName(label)
```

âœ… This includes:

* Upload payload (`formData.append('documentType', ...)`)
* Display filtering (`uploadedFiles.filter(...)`)
* Validation matching (`validateDocumentUploads()`)

---

### ğŸš« PATCH 3 â€” Filter Validation Logic to Use Unique Normalized Document Types

**File:** `client/src/components/DynamicDocumentRequirements.tsx`
**Section:** `validateDocumentUploads()` or wherever requirements are checked

#### âœ… Step 3.1 â€” Deduplicate requirements by `documentType`:

```ts
const uniqueRequirements = Array.from(
  new Map(documentRequirements.map(req => [
    normalizeDocumentName(req.label),
    req
  ])).values()
);
```

#### âœ… Step 3.2 â€” Perform validation based on `uniqueRequirements`, not raw list.

---

### ğŸ§ª VALIDATION TEST

After patching, test this application scenario:

* Category: **Factoring**
* Country: **Canada**
* Upload 3x Financials, 6x Bank Statements
* Ensure:

  * Only one upload box per type appears
  * Validation passes when uploads match requirements
  * No ghost sections marked "Required" with no upload allowed

---

### ğŸ§¼ CLEANUP & COMMIT

âœ… Confirm:

* No console errors
* Only 1 upload section per document type
* Validation passes when appropriate uploads exist

âœ… Commit with message:

```
Fix Step 5 Document Deduplication + Validation Mapping
```

---

Let me know when Replit completes this so I can run a sanity check or generate test cases for you.
