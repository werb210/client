Thanks â€” hereâ€™s how to **immediately diagnose and fix** the `Internal Server Error` showing in the **staff production version** (`https://staff.boreal.financial/`):

---

## ğŸ” **Step-by-Step Diagnostic Checklist**

### âœ… 1. **Check Logs on Replit (or Hosting Environment)**

Look at the Replit â€œShellâ€ or â€œConsoleâ€ output:

```bash
# Replit Console Logs
npm run start
# or if using tsx
npx tsx server/index.ts
```

Look for:

* Stack traces
* Environment variable errors (e.g., `SIGNNOW_API_TOKEN is undefined`)
* Routing errors
* Database connection issues

---

### âœ… 2. **Environment Variables Audit**

A **missing secret** is the most common cause of a `500 Internal Server Error` in production.

Check for missing/undefined variables in **Replit Secrets**:

* âœ… `JWT_SECRET`
* âœ… `DATABASE_URL`
* âœ… `SIGNNOW_API_TOKEN`
* âœ… `TEMPLATE_ID_PROD`
* âœ… `TWILIO_ACCOUNT_SID`
* âœ… `TWILIO_AUTH_TOKEN`
* âœ… `TWILIO_VERIFY_SERVICE_SID`

**Also check:**

```ts
process.env.NODE_ENV === 'production' // may trigger stricter paths
```

---

### âœ… 3. **Test the Server Endpoint Locally**

From Replit Shell or your dev machine:

```bash
curl -i https://staff.boreal.financial/api/rbac/auth/login
```

Expected:

* `405 Method Not Allowed` or `400` if malformed
* `500` confirms internal crash

---

### âœ… 4. **Check `server/index.ts` for Default Route Handling**

Ensure **no infinite loop or improper wildcard route**:

```ts
app.use("*", (req, res) => {
  res.sendFile(path.join(__dirname, "dist", "index.html"));
});
```

â˜ ï¸ This will fail if `index.html` is missing or `__dirname` resolves incorrectly in production (ESM bug).

âœ… Fix: Replace with Vite-safe path resolution using `import.meta.url` or `resolve()` helper.

---

### âœ… 5. **Build Artifacts Present?**

If serving React with `express.static`, make sure `client/dist` or `apps/staff-portal/dist` is actually built:

```bash
ls client/dist
# or
ls apps/staff-portal/dist
```

If empty, re-run:

```bash
npm run build
```

---

## ğŸ› ï¸ Quick Fix Commands (on Replit)

```bash
# Rebuild frontend if not found
cd client
npm run build
cd ..

# Restart server cleanly
killall node
npx tsx server/index.ts
```

---

## ğŸ“‹ Summary

| Check                | Status                                    |
| -------------------- | ----------------------------------------- |
| âœ… Logs for errors    | Check stack trace or crash                |
| âœ… Secrets configured | JWT, DB, SignNow, Twilio                  |
| âœ… Routing safe       | No wildcard crash                         |
| âœ… React dist present | `client/dist` or `apps/staff-portal/dist` |
| âœ… Vite paths working | `index.html` resolved safely              |
| âœ… Build artifacts    | `npm run build` completed                 |

---

Would you like me to:

* Scan your deployed site for specific error codes?
* Walk through rewriting the routing fallback safely for production?
* Help debug the Replit console output?

Let me know what you see in the logs or if you'd like a `server/index.ts` fix template.
