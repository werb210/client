# CLIENT APP â€” Cross-check integration points (no duplicates; verify Step 2/5 and staff CRM coupling)
set -euo pipefail
AUDIT_AT="$(date +%F_%H-%M-%S)"
R="reports/client-crm-crosscheck-$AUDIT_AT"; mkdir -p "$R"

echo "== 1) Ensure single products fetcher and no /lenders in Step 2 =="
PF_COUNT="$(rg -l "export async function fetchProducts" client/src | wc -l | tr -d ' ')"
if [ "$PF_COUNT" -eq 1 ]; then echo "PASS: single products fetcher" | tee -a "$R/summary.txt"; else echo "FAIL: multiple fetchers ($PF_COUNT)" | tee -a "$R/summary.txt"; fi
rg -n "/lenders\\b" client/src | tee "$R/lenders_refs.txt" >/dev/null || true
if [ ! -s "$R/lenders_refs.txt" ]; then echo "PASS: no /lenders usage in Step 2" | tee -a "$R/summary.txt"; else echo "FAIL: /lenders references remain" | tee -a "$R/summary.txt"; fi

echo "== 2) Submission payload includes CRM-critical fields =="
# Scan Step 1-5 for required keys expected by staff Contacts/Pipeline/Marketing/Reports
REQ_KEYS='email|phone|legalName|businessName|loanAmount|country|province|marketingConsent|gdpr_optin'
rg -n "$REQ_KEYS" client/src -g '!*node_modules*' | tee "$R/required_key_refs.txt" >/dev/null || true
[ -s "$R/required_key_refs.txt" ] && echo "PASS: client references CRM-critical keys" | tee -a "$R/summary.txt" || echo "FAIL: missing CRM-critical keys" | tee -a "$R/summary.txt"

echo "== 3) Probe staff endpoints from client env =="
STAFF="${VITE_STAFF_API_URL:-https://staff.boreal.financial/api}"
HDR=(); [ -n "${VITE_CLIENT_APP_SHARED_TOKEN:-}" ] && HDR=(-H "Authorization: Bearer $VITE_CLIENT_APP_SHARED_TOKEN")
echo "Products count:" | tee -a "$R/probes.txt"
curl -s "${STAFF%/}/v1/products" "${HDR[@]}" | jq 'length' | tee -a "$R/probes.txt" >/dev/null || true
echo "Pipeline cards (public list expected 200):" | tee -a "$R/probes.txt"
curl -s -o /dev/null -w "%{http_code}\n" "${STAFF%/}/pipeline/cards" | tee -a "$R/probes.txt" >/dev/null || true
echo "Reports summary:" | tee -a "$R/probes.txt"
curl -s "${STAFF%/}/reports/summary" | jq '.totals' | tee -a "$R/probes.txt" >/dev/null || true

echo "== 4) Build check (no duplicates created) =="
npm run -s build >/dev/null 2>&1 && echo "PASS: client build ok" | tee -a "$R/summary.txt" || { echo "FAIL: client build failed" | tee -a "$R/summary.txt"; npm run build 2>&1 | head -40 | tee "$R/build_error.txt"; }

echo
echo "=== SUMMARY ==="
cat "$R/summary.txt"
echo
echo "Reports: $R"
