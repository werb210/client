BLOCK B — CLIENT APP FIXES

(Frontend: WebSocket integration + API auth + live lender sync)

1. Update Environment Variables (.env.production)
VITE_API_URL=https://staff.boreal.financial
VITE_WS_URL=wss://staff.boreal.financial/socket.io
VITE_CLIENT_TOKEN=<secure-client-token>

2. Fix API Client

File: src/lib/api.ts

const API_URL = import.meta.env.VITE_API_URL;
const CLIENT_TOKEN = import.meta.env.VITE_CLIENT_TOKEN;

export async function fetchLenderProducts() {
  const res = await fetch(`${API_URL}/api/lender-products`, {
    headers: { Authorization: `Bearer ${CLIENT_TOKEN}` },
  });

  if (!res.ok) {
    console.error("❌ Failed to fetch lender products:", res.status, await res.text());
    return [];
  }

  return res.json();
}

3. Add WebSocket Hook

File: src/hooks/useWebSocket.ts

import { useEffect } from "react";
import { io } from "socket.io-client";
import { queryClient } from "@/lib/queryClient";

const WS_URL = import.meta.env.VITE_WS_URL;
const CLIENT_TOKEN = import.meta.env.VITE_CLIENT_TOKEN;

export function useWebSocket() {
  useEffect(() => {
    const socket = io(WS_URL, {
      transports: ["websocket"],
      auth: { token: CLIENT_TOKEN }
    });

    socket.on("connect", () => console.log("✅ WebSocket connected"));

    socket.on("lender-products:update", () => {
      console.log("🔄 Lender products updated");
      queryClient.invalidateQueries(["lender-products"]);
    });

    socket.on("pipeline:update", () => {
      console.log("🔄 Pipeline updated");
      queryClient.invalidateQueries(["pipeline"]);
    });

    socket.on("disconnect", () => console.warn("⚠️ WebSocket disconnected"));

    return () => socket.disconnect();
  }, []);
}

4. Integrate WebSocket Hook Globally

File: src/App.tsx

import { useWebSocket } from "@/hooks/useWebSocket";

export default function App() {
  useWebSocket(); // ✅ Enables live updates globally

  return (
    // ...existing routing/UI...
  );
}

RESULT AFTER PATCH
✅ Staff App

WebSocket + API unified under https://staff.boreal.financial

CORS + auth aligned for client.boreal.financial

Emits events for lender products, pipeline, and applications

No more ERR_NAME_NOT_RESOLVED

✅ Client App

Uses one global CLIENT_TOKEN

Subscribes to lender product + pipeline updates

Automatically refreshes UI when server emits changes

Next Step

Apply Block A to the Staff App

Apply Block B to the Client App

Rebuild both apps

Test:

curl https://staff.boreal.financial/api/lender-products \
  -H "Authorization: Bearer <CLIENT_TOKEN>"


Watch real-time updates propagate across apps.