# =======================
# CLIENT — purge SignNow noise + refresh products to 42
# Requirements: bash, curl, jq, rg (ripgrep)
# =======================

set -euo pipefail

CLIENT_BASE="${CLIENT_BASE:-http://localhost:5000}"
STAFF_BASE="${STAFF_BASE:-https://staff.boreal.financial}"

echo "== A) Remove/Silence SignNow =="
# 1) If any SignNow lines remain, comment them out (logs/imports)
if command -v rg >/dev/null 2>&1; then
  mapfile -t SIGNNOW_FILES < <(rg -n --hidden -S "SIGNNOW|SignNow" -g "server/**" -l || true)
else
  SIGNNOW_FILES=()
fi

if [ "${#SIGNNOW_FILES[@]}" -gt 0 ]; then
  for f in "${SIGNNOW_FILES[@]}"; do
    cp "$f" "$f.signnow.bak" || true
    # comment out any SignNow imports/log lines safely
    sed -i.bak -E 's/^(.*SignNow.*)$/\/\/ \1/g' "$f" || true
    sed -i.bak -E 's/^(.*SIGNNOW.*)$/\/\/ \1/g' "$f" || true
  done
  echo "🧹 SignNow references commented. (Backups: *.signnow.bak / *.bak)"
else
  echo "✅ No SignNow references found in server/**"
fi

# 2) Add a clean startup log (optional): create a noop marker
mkdir -p server/_boot 2>/dev/null || true
cat > server/_boot/signnow-removed.log.js <<'JS'
// SignNow was removed; keep startup clean.
export function logSignNowStatus() {
  console.log("🧹 SignNow integration removed/disabled.");
}
JS

# If your server/index.ts calls a signnow status logger, point it to this one.
# Otherwise this file is harmless and keeps future logs clean.

echo
echo "== B) Fix product cache: should be 42 (17 CA / 25 US) =="

# 0) Try a clean slate: remove any local cache file(s) if present
echo "-- clearing stale local cache files (best-effort) --"
find server -maxdepth 3 -type f \( -iname "*lender*cache*.json" -o -iname "products*cache*.json" \) -print -exec rm -f {} \; || true

# 1) Force a fresh pull from Staff
echo "-- pulling from Staff now --"
curl -sS -X POST "$CLIENT_BASE/internal/pull-staff-products" \
  -H 'content-type: application/json' -d '{}' | jq '.' || true

# 2) Verify client now serves 42 and the CA/US split
echo "-- verifying client catalog --"
C_RAW="$(curl -fsS "$CLIENT_BASE/api/v1/products" || echo '[]')"
if echo "$C_RAW" | jq -e 'type=="array"' >/dev/null 2>&1; then
  C_LIST="$C_RAW"
else
  C_LIST="$(echo "$C_RAW" | jq -c '.items // []')"
fi

TOTAL="$(echo "$C_LIST" | jq 'length')"
CA_COUNT="$(echo "$C_LIST" | jq '[.[] | select((.country // .countryOffered // "NULL")|ascii_upcase=="CA")] | length')"
US_COUNT="$(echo "$C_LIST" | jq '[.[] | select((.country // .countryOffered // "NULL")|ascii_upcase=="US")] | length')"

echo "Client totals: TOTAL=$TOTAL, CA=$CA_COUNT, US=$US_COUNT"
if [ "$TOTAL" = "42" ] && [ "$CA_COUNT" = "17" ] && [ "$US_COUNT" = "25" ]; then
  echo "✅ Client cache matches Staff: 42 (17 CA / 25 US)"
else
  echo "⚠️ Still off. Running deeper checks…"

  echo "-- server thought it had (from startup log) --"
  echo "  (Your earlier log said: Found 32 products in local cache)"
  echo "-- Staff ground truth --"
  S_RAW="$(curl -fsS "$STAFF_BASE/api/v1/products" || echo '[]')"
  if echo "$S_RAW" | jq -e 'type=="array"' >/dev/null 2>&1; then
    S_LIST="$S_RAW"
  else
    S_LIST="$(echo "$S_RAW" | jq -c '.items // []')"
  fi
  S_TOTAL="$(echo "$S_LIST" | jq 'length')"
  S_CA="$(echo "$S_LIST" | jq '[.[] | select((.countryOffered // .country // "NULL")|ascii_upcase=="CA")] | length')"
  S_US="$(echo "$S_LIST" | jq '[.[] | select((.countryOffered // .country // "NULL")|ascii_upcase=="US")] | length')"
  echo "Staff totals: TOTAL=$S_TOTAL, CA=$S_CA, US=$S_US"

  echo "-- inspecting first item keys (client vs staff) --"
  echo "Client keys:"; echo "$C_LIST" | jq '.[0] | keys' 2>/dev/null || echo "no client items"
  echo "Staff keys:";  echo "$S_LIST" | jq '.[0] | keys'  2>/dev/null || echo "no staff items"

  echo
  echo "👉 If Staff is 42 but Client is 32, the client is either:"
  echo "   • still reading a stale cache file (ensure the find/rm above removed it), or"
  echo "   • running in push mode and hasn’t received a push. Quick fix: stay pull-first."
  echo
  echo "-- forcing one more pull and recheck --"
  curl -sS -X POST "$CLIENT_BASE/internal/pull-staff-products" -H 'content-type: application/json' -d '{}' >/dev/null || true
  sleep 1
  curl -sS "$CLIENT_BASE/api/v1/products" | jq '[.[]|.country // .countryOffered // "NULL"] | group_by(.) | map({country: .[0], count: length})'
fi

echo
echo "== C) Startup log hardening (optional, keeps console clean) =="
# Replace noisy 'local cache found X' with a clearer message that also logs pull mode.
STARTUP_FILE="$(rg -n -S 'Found .* products in local cache|push-based lender products system' -g 'server/**' -l | head -n1 || true)"
if [ -n "${STARTUP_FILE:-}" ]; then
  cp "$STARTUP_FILE" "$STARTUP_FILE.cachelog.bak" || true
  sed -i.bak -E 's/Found [0-9]+ products in local cache/Local products cache loaded/g' "$STARTUP_FILE" || true
  sed -i.bak -E 's/push-based lender products system/using pull-first sync; staff is source of truth/g' "$STARTUP_FILE" || true
  echo "🧽 Startup log wording softened in: $STARTUP_FILE"
else
  echo "No startup-log lines found to patch (skipped)."
fi

echo
echo "✅ Done. SignNow noise removed/silenced, and catalog refreshed against Staff."
