CLIENT APPLICATION

Goal: Confirm weâ€™re calling the exact paths Staff exposes, and prove weâ€™re not accidentally hitting a different base or stale cache/fallback.

Block (run in Client repo root shell):

set -euo pipefail

echo "ðŸ”Ž ENV"
echo "VITE_STAFF_API_URL=${VITE_STAFF_API_URL:-<unset>}"
echo "VITE_CLIENT_APP_SHARED_TOKEN=${VITE_CLIENT_APP_SHARED_TOKEN:-<unset>}"

# 1) Hit staff diagnostics directly from the client shell (bypasses app code)
BASE="${VITE_STAFF_API_URL:-https://staff.boreal.financial/api}"
TOK="${VITE_CLIENT_APP_SHARED_TOKEN:-REDACTED}"

echo "ðŸ”Ž Staff routes (first 10)"
curl -sS "${BASE%/}/_int/routes" | jq '.routes | length, .routes[0:10]'

echo "ðŸ”Ž DB sanity via client"
curl -sS -H "Authorization: Bearer $TOK" "${BASE%/}/_int/db-sanity" | jq '.user, .products, .lenders'

# 2) Probe both product paths (SoT vs canonical), return item counts quickly
echo "ðŸ”Ž Products (SoT style: /v1/products)"
curl -sS -H "Authorization: Bearer $TOK" "${BASE%/}/v1/products" | jq 'if type=="array" then length else . end'

echo "ðŸ”Ž Products (canonical candidate: /lender-products)"
curl -sS -H "Authorization: Bearer $TOK" "${BASE%/}/lender-products" | jq 'if type=="array" then length else . end'

# 3) Lenders
echo "ðŸ”Ž Lenders (/lenders)"
curl -sS -H "Authorization: Bearer $TOK" "${BASE%/}/lenders" | jq 'if type=="array" then length else . end'

# 4) Validate-intake â€” try both namespaces (SoT and non-SoT)
echo "ðŸ”Ž validate-intake checks"
curl -sSI "${BASE%/}/applications/validate-intake" | sed -n '1,10p'
curl -sSI "${BASE%/}/v1/applications/validate-intake" | sed -n '1,10p'


What to look for

If /v1/products returns 0 but /lender-products returns 44, then the path alias is the issue â†’ keep the alias (or update client).

If both return 0, but Staffâ€™s server-side db-sanity shows count > 0, then a role/tenant filter is excluding results for the shared token â†’ Staff should allow read-only visibility for that service user in those list endpoints.

If validate-intake is 404 on /v1/... but 200 on /applications/validate-intake, update the client path (or keep a guarded alias on staff).

âœ… Expected Outcomes

Youâ€™ll discover which path variant actually returns real data in prod.

If the service user is filtered, youâ€™ll see it in db-sanity vs client hits â€” then loosen read filters only when ALLOW_CLIENT_SHARED_TOKEN=1 && user.service === 'client-shared-token'.

Youâ€™ll verify the correct route for validate-intake and either:

switch the client to the working path, or

keep a temporary alias (guarded by API_DIAG=1) on Staff.