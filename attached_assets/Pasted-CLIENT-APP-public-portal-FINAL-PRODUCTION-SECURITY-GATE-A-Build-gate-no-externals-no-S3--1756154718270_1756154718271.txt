CLIENT APP (public portal) — FINAL PRODUCTION & SECURITY GATE
A) Build gate (no externals / no S3)
# from client repo root

# 1) source scan
rg -n "s3|amazonaws|minio|presign|SignedURL|putObject|getSignedUrl" src \
  || echo "✅ no S3 refs in client src"
rg -n --pcre2 "https?://(?!localhost|127\.0\.0\.1)" src \
  | rg -v "/(dev|demo|test|playground)/|Example|Mock|Stub" \
  || echo "✅ no external URLs in production code"

# 2) production build + bundle scan
npm run build
rg -n --pcre2 "https?://(?!localhost|127\.0\.0\.1)" dist || echo "✅ dist clean"

B) Single API surface (verify wrapper)
rg -n "export .*uploadDocument|listDocuments|setDocumentStatus" src/lib/api.ts
rg -n "/api/applications/.+/documents/upload" src | wc -l
rg -n "/api/public/applications/.+/documents" src | rg -v "dev|test" || echo "✅ no prod public-docs"

C) Dev runtime guard (dev-only)
rg -n "fetch-guard" src/main.tsx && echo "✅ guard imported (dev only)"
rg -n "Blocked external fetch in dev" src/lib/fetch-guard.ts && echo "✅ guard message present"

D) Prod browser smoke (auth cookie/JWT in browser)

Open the client site → DevTools Console:

// 1) SHOULD WORK when authenticated
const appId = "2ebf6120-512e-428f-b1c1-094acf4b6edc";
const fd = new FormData();
fd.append("file", new File([new Blob(["ok"],{type:"text/plain"})], "test.txt"));
fd.append("document_type","bank_statements");
(await fetch(`/api/applications/${appId}/documents/upload`, { method:"POST", body:fd, credentials:"include" })).status;
// expect: 200 (or 401/403 if not logged in)

// 2) SHOULD FAIL in prod (route not mounted)
(await fetch(`/api/public/applications/${appId}/documents`, { credentials:"include" })).status;
// expect: 404/403

E) Optional prod-hardening quickies
# silence console in prod (optional)
rg -n "console\." src | wc -l   # target minimal logs
# vite source maps off (optional)
rg -n "sourcemap" vite.config.* || echo "ℹ️ consider build.sourcemap=false"


GO = A-D all pass.
NO-GO = any external URL in dist, or public docs route returns 200.