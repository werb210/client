<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Draft-First Workflow Test</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #00ff00; }
        .log { margin: 5px 0; }
        .error { color: #ff4444; }
        .success { color: #44ff44; }
        .info { color: #4444ff; }
        button { padding: 10px 20px; margin: 10px; background: #333; color: #fff; border: 1px solid #666; cursor: pointer; }
        button:hover { background: #555; }
        #output { background: #000; padding: 15px; border: 1px solid #333; height: 500px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>🧪 Draft-First Architecture Test</h1>
    <p>This test verifies the complete Steps 4 → 5 → 7 workflow with network monitoring.</p>
    
    <div>
        <button onclick="runCompleteTest()">🚀 Run Complete Test</button>
        <button onclick="clearOutput()">🧹 Clear Output</button>
        <button onclick="openDevTools()">🔧 Open DevTools Network Tab</button>
    </div>
    
    <div id="output"></div>

    <script>
        const output = document.getElementById('output');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            output.appendChild(div);
            output.scrollTop = output.scrollHeight;
            console.log(message);
        }
        
        function clearOutput() {
            output.innerHTML = '';
        }
        
        function openDevTools() {
            log("📋 Instructions:", 'info');
            log("1. Open DevTools (F12)", 'info');
            log("2. Go to Network tab", 'info');
            log("3. Clear existing requests", 'info');
            log("4. Run the test", 'info');
            log("5. Watch for the expected calls:", 'info');
            log("   - POST /api/public/applications (200)", 'info');
            log("   - 6x POST /api/public/applications/:id/documents (200)", 'info');
            log("   - PATCH /api/public/applications/:id (200)", 'info');
        }

        // Test Step 4: Application Creation
        async function testStep4ApplicationCreation() {
            log("=== STEP 4 TEST: Application Creation ===", 'info');
            
            const step4Data = {
                step1: {
                    requestedAmount: 50000,
                    fundsPurpose: "working_capital",
                    lookingFor: "financing",
                    headquarters: "CA"
                },
                step3: {
                    operatingName: "Test Business Inc",
                    legalName: "Test Business Inc",
                    businessStreetAddress: "123 Main St",
                    businessCity: "Toronto",
                    businessState: "ON",
                    businessZipCode: "M5V 3A8",
                    businessPhone: "+1-416-555-0123",
                    businessStartDate: "2020-01-15",
                    businessStructure: "corporation",
                    numberOfEmployees: 5,
                    estimatedYearlyRevenue: 500000
                },
                step4: {
                    applicantFirstName: "John",
                    applicantLastName: "Smith", 
                    applicantEmail: "john@testbusiness.com",
                    applicantPhone: "+1-416-555-0456",
                    applicantAddress: "456 Oak Ave",
                    applicantCity: "Toronto",
                    applicantState: "ON",
                    applicantZipCode: "M5V 3B9",
                    applicantDateOfBirth: "1985-03-15",
                    ownershipPercentage: 100,
                    hasPartner: false
                }
            };

            try {
                log("📤 POST /api/public/applications", 'info');
                
                const response = await fetch('/api/public/applications', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(step4Data)
                });
                
                log(`📥 Response: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    const errorText = await response.text();
                    log(`❌ Step 4 Failed: ${errorText}`, 'error');
                    return null;
                }
                
                const result = await response.json();
                log(`✅ Step 4 Success: ${JSON.stringify(result)}`, 'success');
                log(`🆔 Application ID: ${result.applicationId}`, 'success');
                
                return result.applicationId;
                
            } catch (error) {
                log(`❌ Step 4 Error: ${error.message}`, 'error');
                return null;
            }
        }

        // Test Step 5: Document Upload
        async function testStep5DocumentUpload(applicationId) {
            log("=== STEP 5 TEST: Document Upload ===", 'info');
            
            if (!applicationId) {
                log("❌ No applicationId provided for Step 5", 'error');
                return false;
            }
            
            // Create 6 test PDF files
            const testFiles = [
                { name: "bank_statement_1.pdf", type: "application/pdf", content: "Bank Statement 1", docType: "bank_statements" },
                { name: "bank_statement_2.pdf", type: "application/pdf", content: "Bank Statement 2", docType: "bank_statements" },
                { name: "bank_statement_3.pdf", type: "application/pdf", content: "Bank Statement 3", docType: "bank_statements" },
                { name: "financial_statement_1.pdf", type: "application/pdf", content: "Financial Statement 1", docType: "financial_statements" },
                { name: "financial_statement_2.pdf", type: "application/pdf", content: "Financial Statement 2", docType: "financial_statements" },
                { name: "tax_return.pdf", type: "application/pdf", content: "Tax Return", docType: "tax_returns" }
            ];
            
            log(`📄 6-file array before upload: ${testFiles.map(f => f.name).join(', ')}`, 'info');
            
            let successCount = 0;
            
            for (let i = 0; i < testFiles.length; i++) {
                const file = testFiles[i];
                const formData = new FormData();
                
                // Create actual File object
                const blob = new Blob([file.content], { type: file.type });
                const actualFile = new File([blob], file.name, { type: file.type });
                
                formData.append('document', actualFile);
                formData.append('documentType', file.docType);
                
                try {
                    log(`📤 POST /api/public/applications/${applicationId}/documents (${i + 1}/6) - ${file.name}`, 'info');
                    
                    const response = await fetch(`/api/public/applications/${applicationId}/documents`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    log(`📥 Response ${i + 1}/6: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                    
                    if (response.ok) {
                        const result = await response.json();
                        log(`✅ Upload ${i + 1}/6 Success: ${JSON.stringify(result)}`, 'success');
                        successCount++;
                    } else {
                        const errorText = await response.text();
                        log(`❌ Upload ${i + 1}/6 Failed: ${errorText}`, 'error');
                    }
                    
                } catch (error) {
                    log(`❌ Upload ${i + 1}/6 Error: ${error.message}`, 'error');
                }
            }
            
            log(`📊 Step 5 Summary: ${successCount}/6 uploads successful`, successCount === 6 ? 'success' : 'error');
            return successCount === 6;
        }

        // Test Step 7: Application Finalization
        async function testStep7Finalization(applicationId) {
            log("=== STEP 7 TEST: Application Finalization ===", 'info');
            
            if (!applicationId) {
                log("❌ No applicationId provided for Step 7", 'error');
                return false;
            }
            
            const finalizationData = {
                status: "submitted",
                termsAccepted: true,
                privacyAccepted: true,
                submissionTimestamp: new Date().toISOString()
            };
            
            try {
                log(`📤 PATCH /api/public/applications/${applicationId}`, 'info');
                log(`Body: ${JSON.stringify(finalizationData)}`, 'info');
                
                const response = await fetch(`/api/public/applications/${applicationId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(finalizationData)
                });
                
                log(`📥 Response: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    const errorText = await response.text();
                    log(`❌ Step 7 Failed: ${errorText}`, 'error');
                    return false;
                }
                
                const result = await response.json();
                log(`✅ Step 7 Success: ${JSON.stringify(result)}`, 'success');
                
                return true;
                
            } catch (error) {
                log(`❌ Step 7 Error: ${error.message}`, 'error');
                return false;
            }
        }

        // Run Complete Workflow Test
        async function runCompleteTest() {
            log("🚀 Starting Complete Draft-First Workflow Test", 'info');
            log("Expected Network Calls:", 'info');
            log("Step 4: POST /api/public/applications 200 (Response carries applicationId)", 'info');
            log("Step 5: 6× POST /api/public/applications/:id/documents 200 (Fires on each chosen PDF)", 'info');
            log("Step 7: PATCH /api/public/applications/:id 200 (Body: { status:\"submitted\", … })", 'info');
            log("", 'info');
            
            // Step 4: Create Application
            const applicationId = await testStep4ApplicationCreation();
            if (!applicationId) {
                log("🚫 Test stopped - Step 4 failed", 'error');
                return;
            }
            
            // Step 5: Upload Documents
            const step5Success = await testStep5DocumentUpload(applicationId);
            if (!step5Success) {
                log("⚠️ Step 5 had failures but continuing to Step 7", 'error');
            }
            
            // Step 7: Finalize Application
            const step7Success = await testStep7Finalization(applicationId);
            
            // Summary
            log("", 'info');
            log("🏁 WORKFLOW TEST COMPLETE", 'info');
            log(`Step 4 (Application Creation): ${applicationId ? "✅ SUCCESS" : "❌ FAILED"}`, applicationId ? 'success' : 'error');
            log(`Step 5 (Document Upload): ${step5Success ? "✅ SUCCESS" : "❌ FAILED"}`, step5Success ? 'success' : 'error');
            log(`Step 7 (Finalization): ${step7Success ? "✅ SUCCESS" : "❌ FAILED"}`, step7Success ? 'success' : 'error');
            
            if (applicationId && step5Success && step7Success) {
                log("🎉 DRAFT-FIRST ARCHITECTURE FULLY OPERATIONAL!", 'success');
            } else {
                log("⚠️ Some issues detected - review logs above", 'error');
            }
        }
        
        // Initialize
        log("✅ Test page loaded. Click 'Run Complete Test' to start.", 'success');
        log("💡 Open DevTools Network tab first to monitor calls.", 'info');
    </script>
</body>
</html>