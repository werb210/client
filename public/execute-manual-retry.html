<!DOCTYPE html>
<html>
<head>
    <title>Execute Manual Retry - S3 Test</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #fff; }
        .result { background: #2a2a2a; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { border-left: 4px solid #4caf50; }
        .error { border-left: 4px solid #f44336; }
        .info { border-left: 4px solid #2196f3; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body>
    <h1>üîÑ Manual Retry Execution - S3 Integration Test</h1>
    <p>Testing window.manualRetryAll() with current S3 endpoint configuration</p>
    
    <button onclick="installAndExecute()" style="padding: 10px 20px; font-size: 16px;">
        Execute window.manualRetryAll()
    </button>
    
    <div id="results"></div>

    <script>
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<pre>${message}</pre>`;
            document.getElementById('results').appendChild(div);
            console.log(message);
        }

        async function installAndExecute() {
            log('üîÑ Installing and executing manual retry override...', 'info');
            
            // Install the override function
            window.manualRetryAll = async () => {
                log('üîÑ [MANUAL RETRY OVERRIDE] Starting manual retry with correct endpoint', 'info');
                
                // Use localStorage application ID if available, otherwise use test ID
                const applicationId = localStorage.getItem('applicationId') || 'aac71c9a-d154-4914-8982-4f1a33ef8259';
                log(`üìã [APPLICATION ID] ${applicationId}`, 'info');
                
                // Use the same 6 banking documents that have been tested
                const documentFiles = [
                    'November 2024_1751579433995.pdf',
                    'December 2024_1751579433994.pdf', 
                    'January 2025_1751579433994.pdf',
                    'February 2025_1751579433994.pdf',
                    'March 2025_1751579433994.pdf',
                    'April 2025_1751579433993.pdf'
                ];
                
                const docs = [];
                for (const fileName of documentFiles) {
                    // Create mock file blob for browser testing
                    docs.push({
                        name: fileName,
                        type: "bank_statements",
                        blob: new Blob([`Mock PDF content for ${fileName}`], { type: 'application/pdf' })
                    });
                }

                log(`üìÑ [DOCUMENTS] Found ${docs.length} documents for retry`, 'info');

                let successCount = 0;
                let fallbackCount = 0;
                let errorCount = 0;

                for (const file of docs) {
                    log(`üì§ [UPLOADING] ${file.name}`, 'info');
                    
                    const form = new FormData();
                    form.append("document", file.blob, file.name);
                    form.append("documentType", file.type || "bank_statements");

                    try {
                        const res = await fetch(`/api/public/upload/${applicationId}`, {
                            method: "POST",
                            body: form,
                        });

                        const json = await res.json();
                        log(`üìã [RESPONSE] ${file.name}:\n${JSON.stringify(json, null, 2)}`, 'info');
                        
                        // Check for S3 success indicators
                        if (json.success && json.fallback === false && json.storageKey && json.storage === 's3') {
                            successCount++;
                            log(`‚úÖ [S3 SUCCESS] ${file.name} uploaded successfully`, 'success');
                            log(`   documentId: ${json.documentId}`, 'success');
                            log(`   storageKey: ${json.storageKey}`, 'success');
                            log(`   storage: ${json.storage}`, 'success');
                            log(`   checksum: ${json.checksum || 'N/A'}`, 'success');
                        } else if (json.fallback === true) {
                            fallbackCount++;
                            log(`üîÑ [FALLBACK] ${file.name} still in fallback mode`, 'error');
                            log(`   documentId: ${json.documentId}`, 'error');
                        } else if (json.success && !json.hasOwnProperty('fallback')) {
                            // This might be the current server response format
                            successCount++;
                            log(`‚úÖ [SUCCESS] ${file.name} uploaded (checking S3 format...)`, 'success');
                            log(`   documentId: ${json.documentId}`, 'success');
                            log(`   NOTE: No fallback flag detected - checking if this is S3 format`, 'info');
                        } else {
                            errorCount++;
                            log(`‚ùå [ERROR] ${file.name} upload failed`, 'error');
                            log(`   error: ${json.error || 'Unknown error'}`, 'error');
                        }
                        
                    } catch (error) {
                        errorCount++;
                        log(`‚ùå [FETCH ERROR] ${file.name}: ${error.message}`, 'error');
                    }
                }
                
                log('üéØ [RETRY COMPLETE SUMMARY]', 'info');
                log(`   ‚úÖ Success: ${successCount}`, 'success');
                log(`   üîÑ Fallback: ${fallbackCount}`, 'error');
                log(`   ‚ùå Errors: ${errorCount}`, 'error');
                log(`   üìä Total: ${successCount + fallbackCount + errorCount}`, 'info');
                
                if (successCount > 0 && fallbackCount === 0) {
                    log('üéâ [S3 INTEGRATION CONFIRMED] All uploads successful!', 'success');
                } else if (fallbackCount > 0) {
                    log('‚ö†Ô∏è [MIXED RESULTS] Some fallback responses detected', 'error');
                } else {
                    log('‚ùå [ISSUES DETECTED] Check configuration', 'error');
                }
                
                return { successCount, fallbackCount, errorCount };
            };

            // Execute the function
            try {
                const result = await window.manualRetryAll();
                log(`Final Result: ${JSON.stringify(result)}`, 'success');
            } catch (error) {
                log(`Execution Error: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>