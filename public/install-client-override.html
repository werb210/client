<!DOCTYPE html>
<html>
<head>
    <title>Client Retry Override Installation</title>
</head>
<body>
    <h1>üìã CLIENT APPLICATION PATCH - Install Retry Override</h1>
    <p>This patch overrides the retry path to hit the correct endpoint only.</p>
    
    <div id="status">Ready to install override...</div>
    <button onclick="installOverride()">Install Override</button>
    <button onclick="testOverride()">Test Override</button>
    
    <pre id="results"></pre>

    <script>
        function installOverride() {
            // Override window.manualRetryAll function to hit correct endpoint
            window.manualRetryAll = async () => {
                console.log('üîÑ [MANUAL RETRY OVERRIDE] Starting manual retry with correct endpoint');
                
                const applicationId = localStorage.getItem("applicationId");
                if (!applicationId) {
                    console.error('‚ùå [ERROR] No applicationId found in localStorage');
                    return;
                }
                
                console.log(`üìã [APPLICATION ID] ${applicationId}`);
                
                // Use the same 6 banking documents that have been tested
                const documentFiles = [
                    'November 2024_1751579433995.pdf',
                    'December 2024_1751579433994.pdf', 
                    'January 2025_1751579433994.pdf',
                    'February 2025_1751579433994.pdf',
                    'March 2025_1751579433994.pdf',
                    'April 2025_1751579433993.pdf'
                ];
                
                const docs = [];
                for (const fileName of documentFiles) {
                    // Mock file blob for testing (replace with actual file handling)
                    docs.push({
                        name: fileName,
                        type: "bank_statements",
                        blob: new Blob([`Mock content for ${fileName}`], { type: 'application/pdf' })
                    });
                }

                console.log(`üìÑ [DOCUMENTS] Found ${docs.length} documents for retry`);

                let successCount = 0;
                let failureCount = 0;

                for (const file of docs) {
                    console.log(`üì§ [UPLOADING] ${file.name}`);
                    
                    const form = new FormData();
                    form.append("document", file.blob, file.name);
                    form.append("documentType", file.type || "bank_statements");

                    try {
                        const res = await fetch(`/api/public/upload/${applicationId}`, {
                            method: "POST",
                            body: form,
                        });

                        const json = await res.json();
                        console.log("üì§ Retry Result:", json);
                        
                        // Check for S3 success indicators
                        if (json.success && json.fallback === false && json.storageKey && json.storage === 's3') {
                            successCount++;
                            console.log(`‚úÖ [S3 SUCCESS] ${file.name} uploaded successfully`);
                            console.log(`   documentId: ${json.documentId}`);
                            console.log(`   storageKey: ${json.storageKey}`);
                            console.log(`   storage: ${json.storage}`);
                        } else if (json.fallback === true) {
                            failureCount++;
                            console.log(`‚ùå [FALLBACK] ${file.name} still in fallback mode`);
                        } else {
                            failureCount++;
                            console.log(`‚ùå [ERROR] ${file.name} unexpected response`);
                        }
                        
                    } catch (error) {
                        failureCount++;
                        console.error(`‚ùå [FETCH ERROR] ${file.name}:`, error);
                    }
                }
                
                console.log(`üéØ [RETRY COMPLETE] Success: ${successCount}, Failures: ${failureCount}`);
                
                if (successCount === docs.length) {
                    console.log('üéâ [ALL SUCCESS] All documents uploaded to S3 successfully!');
                } else {
                    console.log('‚ö†Ô∏è [PARTIAL/FAILED] Some documents still in fallback mode');
                }
                
                return { successCount, failureCount, total: docs.length };
            };

            document.getElementById('status').innerHTML = '‚úÖ Override installed successfully!';
            console.log('‚úÖ [OVERRIDE INSTALLED] window.manualRetryAll function updated');
            console.log('üìã [USAGE] Run window.manualRetryAll() to test with correct endpoint');
        }
        
        async function testOverride() {
            if (typeof window.manualRetryAll !== 'function') {
                document.getElementById('results').innerHTML = '‚ùå Override not installed yet!';
                return;
            }
            
            document.getElementById('results').innerHTML = 'üîÑ Testing override...\n';
            
            try {
                const result = await window.manualRetryAll();
                document.getElementById('results').innerHTML += `
‚úÖ Test completed!
Success: ${result.successCount}
Failures: ${result.failureCount}
Total: ${result.total}

Check console for detailed logs.
                `;
            } catch (error) {
                document.getElementById('results').innerHTML += `‚ùå Test failed: ${error.message}`;
            }
        }
    </script>
</body>
</html>